<html xmlns:th="http://wwww.thymeleaf.org">

	<header th:fragment="header" class="topbar" data-navbarbg="skin6">
		<nav class="navbar top-navbar navbar-expand-md">
			<div class="navbar-header" data-logobg="skin6">
				<!-- This is for the sidebar toggle which is visible on mobile only -->
				<a class="nav-toggler waves-effect waves-light d-block d-md-none" href="javascript:void(0)">
					<i class="ti-menu ti-close"></i>
				</a>
				<!-- ============================================================== -->
				<!-- Logo -->
				<!-- ============================================================== -->
				<div class="navbar-brand">
					<!-- Logo icon -->
					<a href="/"> 
						<b class="logo-icon"> 
							<!-- Dark Logo icon -->
							<img src="assets/images/logo-icon.png" alt="homepage" class="dark-logo" /> 
							<!-- Light Logo icon --> 
							<img src="assets/images/logo-icon.png" alt="homepage" class="light-logo" />
						</b> <!--End Logo icon --> 
							<!-- Logo text --> 
							<span class="logo-text">
							<!-- dark Logo text --> 
							<img src="assets/images/logo-text.png" alt="homepage" class="dark-logo" /> 
							<!-- Light Logo text --> 
							<img src="assets/images/logo-light-text.png" class="light-logo" alt="homepage" />
						</span>
					</a>
				</div>
				<!-- ============================================================== -->
				<!-- End Logo -->
				<!-- ============================================================== -->
				<!-- ============================================================== -->
				<!-- Toggle which is visible on mobile only -->
				<!-- ============================================================== -->
			</div>
			<!-- ============================================================== -->
			<!-- End Logo -->
			<!-- ============================================================== -->
			<div class="navbar-collapse collapse" id="navbarSupportedContent">
				<ul class="navbar-nav float-left mr-auto ml-3 pl-1"></ul>
				<ul class="navbar-nav float-right">
					<a href="#" id="fixedBtn" class="btn"><i class="fas fa-comments fa-2x"></i></a>
					<!-- ============================================================== -->
					<!-- User profile -->
					<!-- ============================================================== -->
					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle" href="javascript:void(0)" data-toggle="dropdown" 
							aria-haspopup="true" aria-expanded="false" style="line-height: 40px; margin-bottom: 10px;">
							<div class="user-img rounded-circle" style="float: left; background-color: white; overflow: hidden; height: 40px; width: 40px;">
								<div  th:if="${session.currentUser.image == null}" style="top: 0; left: 0; right: 0; bottom: 0; transform: translate(50%, 50%);">
									<span>
										<img src="assets/images/users/4.jpg" alt="user" href="javascript:void(0)"
											style="width: auto; height: 40px; transform: translate(-50%, -50%); display:block">
									</span>
								</div>
								<div th:unless="${session.currentUser.image == null}" style="top: 0; left: 0; right: 0; bottom: 0; transform: translate(50%, 50%);">
									<span>
										<img th:src="@{assets/images/userImage/}+${session.currentUser.image}" alt="user"
											href="javascript:void(0)" style="width: auto; height: 40px; transform: translate(-50%, -50%); display:block">
									</span>
								</div>
							</div> 
								<span class="ml-2 d-none d-lg-inline-block" style="clear: both;">
								<span>Hello,</span> <span class="text-dark" th:text="${session.currentUser.nickname}"></span> 
								<i data-feather="chevron-down" class="svg-icon"></i>
						</span>
					</a>
						<div class="dropdown-menu dropdown-menu-right user-dd animated flipInY">
							<a class="dropdown-item" href="/edituser"><i data-feather="user" class="svg-icon mr-2 ml-1"></i> My Profile</a>	
							<a class="dropdown-item" href="/logout"> <i data-feather="power" class="svg-icon mr-2 ml-1"></i> Logout</a>
						</div>
					</li>
				</ul>
			</div>
		</nav>
		
		<div style="display:none;" id="alert_list">
			<div class="container-fluid">
				<div class="row">
					<div class="col-md-12">
						<div class="card">
							<div class="row no-gutters">
								<div class="col-lg-12  col-xl-12">
									<div class="chat-box scrollable position-relative" style="overflow: auto !important;">
										<ul class="chat-list list-style-none" id="msgUl">
										</ul>
									</div>
									<div class="card-body border-top">
										<div class="row">
											<div class="col-9">
												<div class="input-field mt-0 mb-0">
													<input id="message" placeholder="Type and enter" class="form-control border-0" type="text">
												</div>
											</div>
											<div class="col-3">
												<a id="sendBtn" class="btn-circle btn-lg btn-cyan float-right text-white" href="javascript:void(0);">
													<i class="fas fa-paper-plane"></i>
												</a>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="assets/libs/jquery/dist/jquery.min.js"></script>
		<script src="assets/libs/popper.js/dist/umd/popper.min.js"></script>
		<script>
		console.log($("#fixedBtn"));
		
		$("#fixedBtn").popover({
			/*  title: "Notifiche",*/
				html: true,
				sanitize: false,
				placement: "bottom",
				content: function() {
				  return $("#alert_list").html();
				}
			});

			///////////////////////////////////////////////////////////웹소켓

			var ws = null;
			var loginId = null;

			$(function () {
			    ws = new WebSocket('ws://localhost:8090/chatting');
				ws.onopen = function() {
			   	    console.log('웹소켓 서버 접속 성공-chat.js');
			   	    ws.send('connent∥'+teamNo+"∥"+currUserNickname+"∥"+"님 접속");
			    };
			    // 메세지 받기
			    ws.onmessage = function(evt) {
			    	makeChatBox(evt.data);
			    };
			    ws.onerror = function(evt) {
			    	console.log('웹소켓 에러 발생-chat.js : ' + evt.data);
			    };
			    ws.onclose = function() {
			    	console.log("웹소켓 연결이 종료됨-chat.js");
			    };
			});

			$('#fixedBtn').on({
			    "shown.bs.popover": function(){
			        var input = $(".popover input#message");
			        input.focus();
			        $(document).on('keydown', input, function(key) {
			        	if (key.keyCode == 13) {
			        		if(input.val() != "") {
			        			// 웹소켓 서버에 데이터 전송하기
			        			ws.send('send∥'+teamNo+"∥"+currUserNickname+"∥"+input.val());
			        			input.val("");
			        		}
			        	}
			    	});
					$(document).on('click', '#sendBtn', function() {
						if(input.val() != "") {
							// 웹소켓 서버에 데이터 전송하기
							ws.send('send∥'+teamNo+"∥"+currUserNickname+"∥"+input.val());
							input.val("");
						}
					});
			    }
			});


			function makeChatBox(data) {
				var nickAndMsg = data.split("∥");
				var notice = nickAndMsg[0];
				var nick = nickAndMsg[2];
				var msg = nickAndMsg[3];
				var time = nickAndMsg[4];
				console.log("에코닉네임:"+nick);
				console.log("에코메세지:"+msg);
				console.log("에코타임:"+time);
				let html = "";
				if(notice.trim() == "notice") {
					html += '<li class="chat-item odd list-style-none mt-3">';
					html += 	'<div class="chat-content text-center d-inline-block">';
					html += 		'<div class="box msg p-2 d-inline-block mb-1 box" style="background-color:#ffffcf;">'+ nick+msg +'</div>';
					html += 		'<br>';
					html += 	'</div>';
					html += '</li>';
				} else {
					if(nick.trim() == currUserNickname) {
						html += '<li class="chat-item odd list-style-none mt-3">';
						html += 	'<div class="chat-content text-right d-inline-block">';
						html += 		'<div class="box msg p-2 d-inline-block mb-1 box">'+ msg +'</div>';
						html += 		'<br>';
						html += 	'</div>';
						html += 	'<div class="chat-time text-right d-block font-10 mt-1 mr-0 mb-3 time">'+ time +'</div>';
						html += '</li>';
					} else {
						html += '<li class="chat-item list-style-none mt-3">';
						html += 	'<div class="chat-img d-inline-block">';
						html += 		'<img src="assets/images/userImage/'+ currUserImage +'" alt="user" class="rounded-circle" width="45">';
						html += 	'</div>';
						html += 	'<div class="chat-content d-inline-block">';
						html += 		'<h6 class="font-weight-medium">'+ nick +'</h6>';
						html += 		'<div class="msg p-2 d-inline-block mb-1">'+ msg +'</div>';
						html += 	'</div>';
						html += 	'<div class="chat-time d-block font-10 mt-1 mr-0 mb-3">'+ time +'</div>';
						html += '</li>';
					}
				}
				$(".popover #msgUl").append(html);
				$(".popover .chat-box").scrollTop($(".popover #msgUl")[0].scrollHeight);
			}

			//$('#logoutBtn').click(function() { 
//				$.ajax({
//					url: "<c:url value='/websocket/logout.do' />"
//				})
//				.done(function (result) {
//					ws.send("logout:" + loginId);
//					$("#loginBox, #msgBox, #logoutBox").toggle();
//					loginId = null;
//					$("#result").html("");
//				});
			//});
		</script>
	
	</header>
	

