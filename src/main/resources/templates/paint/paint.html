<!DOCTYPE html>
<html xmlns:th="http://wwww.thymeleaf.org">

<head>
<meta charset="UTF-8">
<link href="css/style.min.css" rel="stylesheet">
    <title>그림판</title>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <style>
    	.paintcellborder{
		border:1px solid grey;
    	}
		i {
		padding-top:12px;
		padding-right:12px;
		padding-left:12px;
		padding-bottom:12px;
		}
		.pad{
		padding-top:10px;
		padding-right:10px;
		padding-left:10px;
		padding-bottom:10px;
		}
		.padd{
		padding-top:60px;
		}
      canvas {
        border: 1px solid grey;
      }
		
      .jb_table {
        display: table;
      }

      .row {
        border-radius: 10px;
        display: table-row;
      }

      .cell {
        display: table-cell;
        vertical-align: top;
      }

      textarea {
        background-color: #fcf3cf;
      }
    </style>


  </head>

  <body>
  
    <div class="jb_table">
      <div class="row">
        
        <span class="cell">
          <div>
            <canvas id="canvas" width="720" height="720"></canvas>
          </div>
        </span>
        <span class="cell">
        <!--   <INPUT type="file" id="load_filename" value="Load" onChange="loadFile()" /> -->
       <!--   <INPUT type="button" value="Redraw" onClick="reDrawCanvas()" />-->
       
          <div>
            <div class="jb_table">
              <div class="row">
                <span class="cell">
                  <img src="img/red.png" class="colorChip" onclick="selectColor('red')" />
                  <img src="img/brown.png" class="colorChip" onclick="selectColor('#FFC7EC')"/>
                </span>
              </div>
              <div class="row">
                <span class="cell">
                   <img src="img/orange.png" class="colorChip" onclick="selectColor('#FF8800')"/>
                   <img src="img/pink.png" class="colorChip" onclick="selectColor('#FF61CA')"/>    		
                </span>
              </div>
              <div class="row">
                <span class="cell">
                  <img src="img/yellow.png" class="colorChip" onclick="selectColor('#FFF705')" />
                  <img src="img/purple.png" class="colorChip" onclick="selectColor('darkviolet')" />
                </span>
              </div>
              <div class="row">
                <span class="cell">
                  <img src="img/lightgreen.png" class="colorChip" onclick="selectColor('lightgreen')"/>
                  <img src="img/white.png" class="colorChip" onclick="selectColor('white')"/>
                </span>
              </div>
              <div class="row">
                <span class="cell">
                 <img src="img/green.png" class="colorChip" onclick="selectColor('green')"/>
                 <img src="img/lightgray.png" class="colorChip" onclick="selectColor('lightgray')"/>
                </span>
              </div>
              <div class="row">
                <span class="cell">
                <img src="img/lightblue.png" class="colorChip" onclick="selectColor('#3DB8FF')" />
                <img src="img/gray.png" class="colorChip" onclick="selectColor('gray')" />
                </span>
              </div>
              <div class="row">
                <span class="cell">
              	   <img src="img/blue.png" class="colorChip" onclick="selectColor('blue')" />
                   <img src="img/black.png" class="colorChip" onclick="selectColor('black')"/>
                </span>
              </div>
              <div class="row">
                  <span class="cell">
                  <input id="colorPicker" type="color" class="form-control" value="#BDB3FF">
 				<!--   <i class="fas fa-eye-dropper"></i>    -->
                  </span>
              </div>
                 <div class="row">
                 <span class="cell">
                  <i class="fas fa-pencil-alt" onclick="selectTool('pencil')"></i>
                  <i class="fas fa-minus" onclick="selectTool('line')"></i>
                </span>
          	    </div> 
            <!--   <div class="row">
                <span class="cell">
                  <img src="../../../dist/img/pencil.png"  onclick="selectTool('pencil')" />
                  <img src="../../../dist/img/line.png"  onclick="selectTool('line')" />
                </span>
              </div> -->
              <div class="row">
                 <span class="cell">
                  <i class="far fa-circle hi"  onclick="selectTool('circle')"></i>
                  <i class="fas fa-circle"  onclick="selectTool('filledcircle')"></i>
                </span>
          	    </div> 
     	        <div class="row">
                 <span class="cell">
                  <i class="far fa-square"  onclick="selectTool('square')"></i>
                  <i class="fas fa-square"  onclick="selectTool('filledsquare')"></i>
                </span>
          	    </div>
               <div class="row">
                <span class="cell">
                  <img src="img/triangle_.png" class="pad hi" onclick="selectTool('tri')" />
                  <img src="img/filledtriangle.png" class="pad" onclick="selectTool('filledtri')" />
                </span>
              </div>
         	<div class="row">
                <span class="cell">
                  <img src="img/bucket1.png" class="pad fill" id="fill"  />
                </span>
              </div>
 <!--             <div class="row">
                <span class="cell">
                  <img src="../../../dist/img/circle.png" onclick="selectTool('circle')"/>
                  <img src="../../../dist/img/filledcircle.png" onclick="selectTool('filledcircle')"/>
                </span>
              </div>
              <div class="row">
                <span class="cell">
                  <img src="../../../dist/img/ellipse.png" onclick="selectTool('ellipse')"/>
                  <img src="../../../dist/img/filledellipse.png" onclick="selectTool('filledellipse')"/>
                </span>
              </div>
              <div class="row">
                <span class="cell">
                  <img src="../../../dist/img/square.png" onclick="selectTool('square')"/>
                  <img src="../../../dist/img/filledsquare.png" onclick="selectTool('filledsquare')"/>
                </span>
              </div>
              <div class="row">
                <span class="cell">
                  <img src="../../../dist/img/rect.png" onclick="selectTool('rect')" />
                  <img src="../../../dist/img/filledrect.png" onclick="selectTool('filledrect')" />
                </span>
              </div> -->

              <div class="row">
                  <span class="cell">
                   <i class="fas fa-angle-double-left" onclick="undo()"></i>
                   <i class="fas fa-angle-double-right" onclick="redo()"></i>
                  </span>
              </div>
              
          <div> <i class="fas fa-quidditch" onClick="initPage()"></i> Clear</div>
          <div class="padd"></div>
          <div>Title <input id="title" size="10" /></div>
          <div>
            <a id="saveImage" download="image.png">
                <i class="fas fa-save" onClick="saveImage()"></i>
            </a>&nbsp;Save</div>
           <!--  <INPUT type="button" value="History" onClick="showHistory()" /> -->
          <div>
            <textarea id="history" cols="40" rows="37" style="display: none;"></textarea>
          </div>
          
            </div>
          </div>
        </span>
      </div>
    </div>
    
    <script src="js/painter.js"></script>
    <script src="js/drawengine.js"></script>
    <!-- 컬러피커 -->
<!--     <input id="colorPicker" type="color" class="form-control" value="#ffffff"> -->
	
    <script language="JavaScript">
    
/*       var textareaList = ["history"]; */
      function clearText(idOfTextArea) {
        document.getElementById(idOfTextArea).value = "";
      }
	 	$('.colorChip').click(function() {
		 	$('.colorChip').removeClass('paintcellborder');
			$(this).addClass('paintcellborder');
		});
		$('#colorPicker').change(function() {
			selectColor($('#colorPicker').val());
			pos.color=$('#colorPicker').val();
		});

/* 		$('.cell').click(function() {
			$('#colorPicker').val()=selectColor;
			console.log('ddddd');
		}); */
      $("#fill").click ( function () {
           ctx.fillStyle=pos.color;
          console.log($('selectColor').val());
          ctx.fillRect(0, 0, 720, 720);
      });
	      
      var canvas = document.querySelector("#canvas");
      var ctx = canvas.getContext("2d");
	//웹소켓
	 var paintWs = null;
	 var now = [];
	 var color = pos.color;
	 var isPress = false;
	 
	 $(document).ready(function(){
		paintWs  = new WebSocket("ws://192.168.0.35:8090/paint");
		paintWs.onopen=function(){
			console.log("웹소켓 접속 성공");
		};
		$("canvas").on(
				{
			mousedown: function (e) {
            	e.preventDefault();
		        isPress = true;
                ctx.beginPath();
				prevX = e.offsetX;
				prevY = e.offsetY;
				//console.log("과연",drwaCommand().mode);
				console.log("추주툴",chooseTool);
            	now.push({"prevX":prevX, "prevY":prevY, "color":pos.color,"mode":chooseTool}); //now 배열에 이거 집어넣음
              	//selectTool('circle');
   	 /*	$('.colorChip').click(function() {
   		 	$('.colorChip').removeClass('paintcellborder');
   			$(this).addClass('paintcellborder');
   		});	*/	
            		
            },
            mousemove: function (e) {
                var x = e.offsetX;
                var y = e.offsetY;
                if (isPress) {
                	now.push({x, y});
                	ctx.moveTo(prevX, prevY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    prevX = e.offsetX;
                    prevY = e.offsetY;
                   if (x <= 10 || y <= 10 || x >= canvas.width-10 || y >= canvas.height-10) {
                        isPress = false;
                    } 
                }
            },
            mouseup: function (e) {
                isPress = false;
                ctx.closePath();
            	paintWs.send(JSON.stringify(now));//now를 json객체로변환
            	now =[]; //now 배열을 다시 비워줌
            }/* ,
   			linemousedown: function (e) {
               	e.preventDefault();
   		        isPress = true;
                ctx.beginPath();
   				prevX = e.offsetX;
   				prevY = e.offsetY;
               	now.push({"prevX":prevX, "prevY":prevY, "color":pos.color}); //now 배열에 이거 집어넣음
                 	
             },
            linemousemove: function (e) {
                   var x = e.offsetX;
                   var y = e.offsetY;
                   if (isPress) {
                   	now.push({x, y});
                   	ctx.moveTo(prevX, prevY);
                       ctx.lineTo(x, y);
                       ctx.stroke();
                       prevX = e.offsetX;
                       prevY = e.offsetY;
                   }
             },
             linemouseup: function (e) {
                   isPress = false;
                   ctx.closePath();
              	 	paintWs.send(JSON.stringify(now));//now를 json객체로변환
             	  	now =[]; //now 배열을 다시 비워줌
             } */
        });
		paintWs.onmessage = function(evt){
			var c = document.querySelector("#canvas");
            var otherCtx = c.getContext("2d");
        	var drawData;
        	var fillData;
        	if (evt.data.startsWith('{')) {
        		fillData = JSON.parse(evt.data);
		        console.log(fillData);
	            if(fillData.mode != undefined && fillData.mode == "fill") {
	            	otherCtx.fillStyle = fillData.color;
	            	otherCtx.fillRect(0, 0, canvas.width, canvas.height);
	            	otherCtx.closePath()
	            	
	            	return;
	            }
        	}
        	if (evt.data.startsWith('[{"')) {
        		drawData = JSON.parse(evt.data);
		        console.log("drawData: ",drawData);
		        //if(drawData[0])
	            otherCtx.strokeStyle = drawData[0].color;
	            otherCtx.beginPath();
		        console.log("드로우데이터: ",drawData[0].prevX, drawData[0].prevY, drawData[0].color,drawData[0].mode)
	            otherCtx.moveTo(drawData[0].prevX, drawData[0].prevY);
				for (let i = 1; i < drawData.length; i++) {
//					console.log(drawData[i].x, drawData[i].y);
		            otherCtx.lineTo(drawData[i].x, drawData[i].y);
				}
				switch(drawData[0].mode){
				case "pencil":
					console.log("펜슬 ㅎㅎ");
					break;
				case "circle":
					console.log("원 ㅎㅎ");
					break;	
				case "square":
					console.log("네모 ㅎㅎ");
					break;
				case "tri":
					console.log("세모 ㅎㅎ");
					break;
				}
	            otherCtx.stroke();
		        otherCtx.closePath();
		    	//selectTool('circle');
        	}
		};
		paintWs.onclose=function(){
			console.log("웹소켓 접속 종료");
		};
		 
		 });	
 
   </script>
  </body>
</html>
