<!DOCTYPE html>
<html xmlns:th="http://wwww.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">
<link rel="icon" type="image/png" sizes="16x16"
	href="assets/images/favicon.png">
<title>Bit 155 Final Project</title>

<link href="css/style.min.css" rel="stylesheet">
<link href="css/kanban.css" rel="stylesheet">
<link rel="stylesheet"
	href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<style>
.paintcellborder {
	border: 2px solid #aeb3ba;
	margin: -2px;
}

.canvas-icon {
	padding-top: 12px;
	padding-right: 12px;
	padding-left: 12px;
	padding-bottom: 12px;
}

.pad {
	padding-top: 10px;
	padding-right: 10px;
	padding-left: 10px;
	padding-bottom: 10px;
}

.padd {
	padding-top: 60px;
}

canvas {
	border: 1px solid #c3c7cd;
	background-color: #ffffff;
}

.jb_table {
	display: table;
}

.roww {
	border-radius: 10px;
	display: table-row;
}

.cell {
	display: table-cell;
	vertical-align: top;
}

textarea {
	background-color: #fcf3cf;
}

.seo {
	position: static !important;
}

#fillicon {
	width: 16px;
	height: 16px;
	color: #6c757d;
}

.page-wrapper>.container-fluid {
	padding: 5px;
	min-height: calc(100vh - 210px);
}

.color-margin {
	margin-bottom: 8px;
}

.colorPicker-width {
	width: 86px;
	display: block;
	height: calc(1.5em + .75rem + 2px);
	padding: 4px;
	line-height: 1.5;
	color: #4F5467;
	background-color: #fff;
	background-clip: padding-box;
	border: 1px solid #e9ecef;
	border-radius: 2px;
	transition: border-color .15s;
	margin-bottom: 8px;
}

.colorPickerarea {
	margin-top: 10px;
	margin-bottom: 10px;
}

.btnn {
	margin-bottom: 5px;
	width: 86px;
}

.btttn {
	margin-bottom: 5px;
	width: 86px;
}

#title{
margin-bottom: 10px;
width:150px;
}
#saveBtn{
width:150px;
}
.saveinput{
	margin-top: 60px;
	margin-left: 15px
}
</style>
</head>

<body>

	<div th:replace="common/scriptA :: scriptA"></div>
	<div id="main-wrapper" data-theme="light" data-layout="vertical"
		data-navbarbg="skin6" data-sidebartype="full"
		data-sidebar-position="fixed" data-header-position="fixed"
		data-boxed-layout="full">

		<th:block th:replace="common/header :: header"></th:block>
		<th:block th:replace="common/aside :: aside"></th:block>
		<th:block th:replace="common/addAllBoardModal"></th:block>
		<!-- ////////////////////////////// 여기에 내용 넣어주세요 ////////////////////////////////////// -->
		<div class="page-wrapper seo">
			<div class="container-fluid">
				<div class="roww">
					<div class="col-12 seo">
						<div class="card seo">
							<div class="card-body seo">
								<div class="jb_table">
									<div class="rowww">

										<span class="cell">
											<div>
												<canvas id="canvas" width="720" height="720"></canvas>
											</div>
										</span> <span class="cell"> <!--   <INPUT type="file" id="load_filename" value="Load" onChange="loadFile()" /> -->
											<!--   <INPUT type="button" value="Redraw" onClick="reDrawCanvas()" />-->
											<div>
												<input type="hidden" teamNo=${teamNo}>
												<div class="jb_table"
													style="margin-left: 50px;">
													<div class="color-margin">
														<span class=""> <img src="img/red.png"
															class="colorChip" onclick="selectColor('red')" /> <img
															src="img/pink.png" class="colorChip"
															onclick="selectColor('#FFC7EC')"
															style="margin-left: 2px;" />
														</span>
													</div>
													<div class="color-margin">
														<span class=""> <img src="img/orange.png"
															class="colorChip" onclick="selectColor('#FF8800')" /> <img
															src="img/deeppink.png" class="colorChip"
															onclick="selectColor('#FF61CA')" style="margin-left: 2px" />
														</span>
													</div>
													<div class="color-margin">
														<span class=""> <img src="img/yellow.png"
															class="colorChip" onclick="selectColor('#FFF705')" /> <img
															src="img/purple.png" class="colorChip"
															onclick="selectColor('darkviolet')"
															style="margin-left: 2px" />
														</span>
													</div>
													<div class="color-margin">
														<span class=""> <img src="img/lightgreen.png"
															class="colorChip" onclick="selectColor('lightgreen')" />
															<img src="img/white.png" class="colorChip"
															onclick="selectColor('white')" style="margin-left: 2px" />
														</span>
													</div>
													<div class="color-margin">
														<span class=""> <img src="img/green.png"
															class="colorChip" onclick="selectColor('green')" /> <img
															src="img/lightgray.png" class="colorChip"
															onclick="selectColor('lightgray')"
															style="margin-left: 2px" />
														</span>
													</div>
													<div class="color-margin">
														<span class=""> <img src="img/lightblue.png"
															class="colorChip" onclick="selectColor('#3DB8FF')" /> <img
															src="img/gray.png" class="colorChip"
															onclick="selectColor('gray')" style="margin-left: 2px" />
														</span>
													</div>
													<div class="color-margin">
														<span class=""> <img src="img/blue.png"
															class="colorChip" onclick="selectColor('blue')" /> <img
															src="img/black.png" class="colorChip"
															onclick="selectColor('black')" style="margin-left: 2px" />
														</span>
													</div>
													<div class="colorPickerarea">
														<span> <input id="colorPicker" type="color"
															class="colorPicker-width" value="#BDB3FF">
														</span>
													</div>
													<div class="btn1">
														<div class="btn-group btnn" role="group"
															aria-label="First group">
															<button type="button"
																class="btn waves-effect waves-light btn-outline-secondary"
																onclick="selectTool('pencil')">
																<i class="fas fa-pencil-alt"></i>
															</button>
															<button type="button"
																class="btn waves-effect waves-light btn-outline-secondary"
																id="fill" onclick="selectTool('filled')">
																<img src="img/bucket1.png" class="fill" id="fillicon" />
															</button>
														</div>
													</div>

													<div class="btn2">
														<div class="btn-group btnn" role="group"
															aria-label="First group">
															<button type="button"
																class="btn waves-effect waves-light btn-outline-secondary"
																onclick="undo()">
																<i class="fas fa-reply"></i>
															</button>
															<button type="button"
																class="btn waves-effect waves-light btn-outline-secondary"
																onclick="redo()">
																<i class="fas fa-share"></i>
															</button>
														</div>
													</div>
													<button
														class="btn waves-effect waves-light btn-outline-secondary btttn"
														type="button" onclick="initPage()">
														<span class="btn-label"><i class="fas fa-eraser"></i></span>
														Clear
													</button>

													
												</div></span>
												<div class="saveinput">
														<input class="form-control" id="title" required=""
															placeholder="제목 입력">
														<a id="saveImage"
															download="image.png">
															<button id="saveBtn" onClick="saveImage()">저장</button>
														</a>
														<textarea id="history" cols="40" rows="37"
															style="display: none;"></textarea>
													</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div th:replace="common/scriptB :: scriptB"></div>
	<script src="js/painter.js"></script>
	<script src="js/drawengine.js"></script>
	<!--  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/js/all.min.js"></script> -->

	<!-- 컬러피커 -->
	<script th:inline="javascript">
    /*<![CDATA[*/
   	var currUserImage = [[${session.currentUser.image}]];
   	var currUserNickname = [[${session.currentUser.nickname}]];
	var currUserImage = [[${session.currentUser.image}]];
	var teamNo = [[${session.currentUser.teamNo}]];
	var teamMember = [[${teamMember}]];
    /*]]>*/
	//		$('.page-wrapper').css('position', '');
   
    if(bgColor == '5f76e8') {
		$('#saveBtn').attr("class", 'btn waves-effect waves-light btn-primary');
	}
	if(bgColor == '22ca80') {
		$('#saveBtn').attr("class", 'btn waves-effect waves-light btn-success');
	}
	if(bgColor == 'fdc16a') {
		$('#saveBtn').attr("class", 'btn waves-effect waves-light btn-warning');
	}
	if(bgColor == 'ff4f70') {
		$('#saveBtn').attr("class", 'btn waves-effect waves-light btn-danger');
	}
	if(bgColor == 'e8eaec' || bgColor == 'ffffff') {
		$('#saveBtn').attr("class", 'btn waves-effect waves-light btn-light');
	}
	if(bgColor == '6c757d') {
		$('#saveBtn').attr("class", 'btn waves-effect waves-light btn-secondary');
	}
	if(bgColor == '1c2d41') {
		$('#saveBtn').attr("class", 'btn waves-effect waves-light btn-dark');
	}
    
    /*       var textareaList = ["history"]; */
    var canvas = document.querySelector("#canvas");
    var ctx = canvas.getContext("2d");
	//웹소켓
	 var paintWs = null;
	 var now = [];
	 var color = pos.color;
	 var isPress = false;
	 
	 $(document).ready(function(){
	 paintWs  = new WebSocket("ws://localhost:8090/paint"); 
 	/*  paintWs  = new WebSocket("ws://192.168.0.35:8090/paint.do?teamNo="+${team.teamNo}); */
		paintWs.onopen=function(){
			/* console.log("웹소켓 접속 성공-paint"); */
			paintWs.send('connect-'+teamNo+"-"+currUserNickname+"-"+"님 페인트 접속");
		};
		$("canvas").on({
			mousedown: function (e) {
          	    e.preventDefault();
		        isPress = true;
                ctx.beginPath();
				prevX = e.offsetX;
				prevY = e.offsetY;
				/* console.log("추주툴",chooseTool); */
          		now.push({"prevX":prevX, "prevY":prevY, "color":pos.color,"mode":chooseTool}); //now 배열에 이거 집어넣음
          /* 		if(chooseTool=="filled"){
          			ctx.fillStyle=pos.color;
          			ctx.fill();	
          		} */
            	//selectTool('circle');
          },
          mousemove: function (e) {
              var x = e.offsetX;
              var y = e.offsetY;
              if (isPress) {
              	  now.push({x, y});
              	  ctx.moveTo(prevX, prevY);
                  ctx.lineTo(x, y);
                  ctx.stroke();
                  prevX = e.offsetX;
                  prevY = e.offsetY;
                 if (x <= 10 || y <= 10 || x >= canvas.width-10 || y >= canvas.height-10) {
                      isPress = false;
                  } 
              }
          },
          mouseup: function (e) {
              isPress = false;
              ctx.closePath();
           /*  console.log("now배열모양 : "+JSON.stringify(now)); */
          	paintWs.send('send-'+teamNo+"-"+currUserNickname+"-"+JSON.stringify(now));//now를 json객체로변환
          	now =[]; //now 배열을 다시 비워줌
          }
      });
		paintWs.onmessage = function(evt){
			makePaintBox(evt.data);
		/* 	console.log("evt.data"+evt.data); */
			var c = document.querySelector("#canvas");
     	    var otherCtx = c.getContext("2d");
      		var drawData;
      		var fillData;
/*       	if (evt.data.startsWith('{')) {
      			fillData = JSON.parse(evt.data);
		        console.log("fillData: "+fillData);
	            if(fillData.mode != undefined && fillData.mode == "filled") {
	            	console.log("이거하니?");
	            	otherCtx.fillStyle = fillData.color;
	            	otherCtx.fillRect(0, 0, canvas.width, canvas.height);
	            	otherCtx.closePath()
	            	return;
	            }
      	} //안탄다.*/
      	if (evt.data.startsWith('[{"')) {
      		drawData = JSON.parse(evt.data);
		     /*    console.log("drawData: ",drawData); */
		        //if(drawData[0])
	            otherCtx.strokeStyle = drawData[0].color;
	            otherCtx.beginPath();
		      /*   console.log("드로우데이터: ",drawData[0].prevX, drawData[0].prevY, drawData[0].color,drawData[0].mode) */
	            otherCtx.moveTo(drawData[0].prevX, drawData[0].prevY);
				for (let i = 1; i < drawData.length; i++) {
//					console.log(drawData[i].x, drawData[i].y);
		            otherCtx.lineTo(drawData[i].x, drawData[i].y);
				}
				if(drawData[0].mode=="filled"){
					otherCtx.fillStyle = drawData[0].color;
	            	otherCtx.fillRect(0, 0, canvas.width, canvas.height);
	            	otherCtx.closePath();
	            	return;
				}
	            otherCtx.stroke();
		        otherCtx.closePath();
		    	//selectTool('circle');
         	}
		};
		paintWs.onerror=function(e){
			console.log("웹소켓 에러 발생-paint"+e.data);	
		}
		paintWs.onclose=function(){
		/* 	console.log("웹소켓 접속 종료-paint"); */
		}
		 });	

	 function makePaintBox(data){
		var nickAndMsg = data.split("-");
		var notice = nickAndMsg[0];
		var nick = nickAndMsg[1];
	 }
	 
	 function clearText(idOfTextArea) {
	        document.getElementById(idOfTextArea).value = "";
	      }
		 	$('.colorChip').click(function() {
			 	$('.colorChip').removeClass('paintcellborder');
				$(this).addClass('paintcellborder');
			});//선택된 컬러 테두리 만들기
			$('#colorPicker').change(function() {
				selectColor($('#colorPicker').val());
				pos.color=$('#colorPicker').val();
			});//컬러 피커 색 선택

	/* 		$('.cell').click(function() {
				$('#colorPicker').val()=selectColor;
				console.log('ddddd');
			}); */
	      $("#fill").click ( function () {
	           ctx.fillStyle=pos.color;
	       /*    console.log($('selectColor').val()); */
	          ctx.fillRect(0, 0, 720, 720);
	      });//색 채우기
		  
	      
   </script>

</body>
</html>
